<?php
namespace frontend\controllers;

use common\models\Article;
use common\models\Read;
use Yii;
use yii\web\Controller;

class PublicController extends Controller{
    public function beforeAction($action)
    {
        $controller = $action->controller->id;
        $page = $action->id;
        $id = Yii::$app->request->get('id');

        if($controller == 'blog' && $page == 'article'){
            $read_data = [];
            $ip = Yii::$app->request->userIP;
            $readModel = new Read();

            $read_data['art_id'] = $id;
            $read_data['ip'] = $ip;
            $read_data['status'] = 1;
            $model = Read::find()
                ->where($read_data)
                ->all();

            if(!$model && $readModel->load(['read'=>$read_data], 'read') && $readModel->validate()){
                $readModel->save();
                $art_model = Article::find()
                    ->where(['id'=>$id, 'status'=>1])
                    ->one();
                $art_model->read_num += 1;
                $art_model->save();
            }

        }
        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function afterAction($action, $result)
    {
        return parent::afterAction($action, $result); // TODO: Change the autogenerated stub
    }
}